# GitHub Actions workflow for production deployments with approval
name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      staging_build_id:
        description: 'Build ID from staging (optional - will use latest successful)'
        required: false
      reason:
        description: 'Reason for production deployment'
        required: true
        default: 'Production release'
      skip_approval:
        description: 'Skip manual approval (admin only)'
        type: boolean
        required: false
        default: false

env:
  STAGING_PROJECT_ID: staging-adk
  PROD_PROJECT_ID: production-adk
  REGION: us-central1

jobs:
  validate-staging:
    name: Validate Staging Success
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    outputs:
      staging_url: ${{ steps.validate.outputs.staging_url }}
      image_url: ${{ steps.validate.outputs.image_url }}

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.STAGING_PROJECT_ID }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Validate staging deployment
        id: validate
        run: |
          echo "ğŸ” Validating staging deployment..."

          # Get staging service URL
          staging_url=$(gcloud run services describe my-agentic-rag \
            --region ${{ env.REGION }} \
            --project ${{ env.STAGING_PROJECT_ID }} \
            --format="value(status.url)")

          echo "staging_url=$staging_url" >> $GITHUB_OUTPUT
          echo "ğŸ“ Staging URL: $staging_url"

          # Get current image
          image_url=$(gcloud run services describe my-agentic-rag \
            --region ${{ env.REGION }} \
            --project ${{ env.STAGING_PROJECT_ID }} \
            --format="value(spec.template.spec.template.spec.containers[0].image)")

          echo "image_url=$image_url" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Image: $image_url"

          # Quick health check
          if curl -f -s --max-time 30 "$staging_url/docs" > /dev/null; then
            echo "âœ… Staging health check passed"
          else
            echo "âŒ Staging health check failed"
            exit 1
          fi

  approve-production:
    name: Approve Production Deployment
    runs-on: ubuntu-latest
    needs: validate-staging
    if: github.event.inputs.skip_approval != 'true'
    environment:
      name: production-approval
      url: https://my-agentic-rag-638797485217.us-central1.run.app

    steps:
      - name: Request approval
        run: |
          echo "ğŸ”’ Manual approval required for production deployment"
          echo "ğŸ“Š Staging URL: ${{ needs.validate-staging.outputs.staging_url }}"
          echo "ğŸ“¦ Image: ${{ needs.validate-staging.outputs.image_url }}"
          echo "ğŸ“ Reason: ${{ github.event.inputs.reason || 'Automated deployment after staging success' }}"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate-staging, approve-production]
    if: always() && (needs.approve-production.result == 'success' || github.event.inputs.skip_approval == 'true')
    environment: production

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}
          project_id: ${{ env.PROD_PROJECT_ID }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Production with Data Pipeline
        id: build
        run: |
          echo "ğŸš€ Starting production deployment..."

          build_id=$(gcloud builds submit \
            --config=.cloudbuild/deploy-to-prod.yaml \
            --project=${{ env.PROD_PROJECT_ID }} \
            --region=${{ env.REGION }} \
            --format="value(name)" \
            --async)

          echo "build_id=$build_id" >> $GITHUB_OUTPUT
          echo "ğŸ”¨ Production build triggered: $build_id"

      - name: Wait for deployment completion
        run: |
          echo "â³ Waiting for production deployment..."
          gcloud builds wait ${{ steps.build.outputs.build_id }} \
            --project=${{ env.PROD_PROJECT_ID }} \
            --region=${{ env.REGION }}

      - name: Get deployment status
        id: status
        run: |
          status=$(gcloud builds describe ${{ steps.build.outputs.build_id }} \
            --project=${{ env.PROD_PROJECT_ID }} \
            --region=${{ env.REGION }} \
            --format="value(status)")

          echo "status=$status" >> $GITHUB_OUTPUT

          if [ "$status" = "SUCCESS" ]; then
            echo "âœ… Production deployment successful!"
          else
            echo "âŒ Production deployment failed with status: $status"
            exit 1
          fi

      - name: Validate production deployment
        run: |
          echo "ğŸ” Validating production deployment..."

          # Get production service URL
          prod_url=$(gcloud run services describe my-agentic-rag \
            --region ${{ env.REGION }} \
            --project ${{ env.PROD_PROJECT_ID }} \
            --format="value(status.url)")

          echo "ğŸŒ Production URL: $prod_url"

          # Health check
          sleep 30  # Allow time for service to be ready
          if curl -f -s --max-time 30 "$prod_url/docs" > /dev/null; then
            echo "âœ… Production health check passed"
          else
            echo "âš ï¸ Production health check failed - service may still be starting"
          fi

      - name: Create GitHub release
        if: steps.status.outputs.status == 'SUCCESS'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: release } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')}`,
              name: `Production Release ${new Date().toISOString().slice(0, 10)}`,
              body: `ğŸš€ **Production Deployment Successful**\n\nğŸ“¦ Image: ${{ needs.validate-staging.outputs.image_url }}\nğŸ”¨ Build ID: ${{ steps.build.outputs.build_id }}\nğŸ“ Reason: ${{ github.event.inputs.reason || 'Automated deployment after staging success' }}\n\nğŸŒ **URLs:**\n- Production: https://my-agentic-rag-638797485217.us-central1.run.app\n- Staging: ${{ needs.validate-staging.outputs.staging_url }}`,
              draft: false,
              prerelease: false
            });

            console.log(`Release created: ${release.html_url}`);

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Production Deployment Failed - ${new Date().toISOString().slice(0, 10)}`,
              body: `âŒ **Production deployment failed**\n\nğŸ”¨ Build ID: ${{ steps.build.outputs.build_id }}\nğŸ“Š Status: ${{ steps.status.outputs.status }}\nğŸ”— Build Logs: https://console.cloud.google.com/cloud-build/builds;region=${{ env.REGION }}?project=${{ env.PROD_PROJECT_ID }}\n\n**Action Required:** Please investigate the build logs and retry deployment.`,
              labels: ['deployment', 'production', 'urgent']
            });
